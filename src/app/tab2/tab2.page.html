<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>My Plan</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="plan-page">
    <section class="hero">
      <div class="range-pill">{{ planRangeLabel() }}</div>
      <h1>Your Healing Sanctuary</h1>
      <p class="hero-sub">Gentle, anti-inflammatory meals for everyday balance.</p>
      <p class="hero-copy">
        Choose a plan length below and pick a start date. We‚Äôll set the end date for you.
      </p>

      <div class="date-grid">
        <div class="date-card date-card-clickable" (click)="openStartDatePicker()">
          <div class="date-label">Start</div>
          <div class="date-main">
            <div class="date-value">{{ planStartDayLabel() }}</div>
            <span class="date-chev">‚Ä∫</span>
          </div>
          <div class="date-sub">{{ planStartDateLabel() }}</div>
        </div>
      </div>
    </section>

    <ion-card class="planner-card">
      <ion-card-header>
        <ion-card-title>Your healing plan</ion-card-title>
      </ion-card-header>

      <ion-card-content>
        <ion-text color="medium">
          <p>
            Answer these quickly so I can create meals that support your hormones, digestion and inflammation üíõ
          </p>
        </ion-text>

        <h2 class="section-title">üïí Eating style</h2>

        <ion-item class="clean-item">
          <ion-label>Fasting style</ion-label>
          <ion-select
            interface="popover"
            [value]="fastingStyle()"
            (ionChange)="fastingStyle.set($event.detail.value)"
          >
            <ion-select-option value="NO_FASTING_3_MEALS">No fasting ¬∑ 3 meals</ion-select-option>
            <ion-select-option value="FASTING_16_8">16:8 fasting</ion-select-option>
            <ion-select-option value="FASTING_18_6">18:6 fasting</ion-select-option>
          </ion-select>
        </ion-item>

        <div class="range-block">
          <ion-range
            min="8"
            max="14"
            step="1"
            [value]="firstMealHour()"
            (ionChange)="onFirstMealHourChange($event.detail.value)"
          >
            <ion-label slot="end">{{ firstMealHour() }}</ion-label>
          </ion-range>

          <ion-text color="medium">
            <p class="helper-text">Breakfast, lunch and dinner spread through the day.</p>
          </ion-text>
        </div>

        <h2 class="section-title">üéØ Focus areas</h2>

        <ion-list lines="none" class="clean-list">
          <ion-item class="clean-item">
            <ion-checkbox
              slot="start"
              [checked]="fibroidFocus()"
              (ionChange)="fibroidFocus.set($event.detail.checked)"
            ></ion-checkbox>
            <ion-label>Support fibroids with fibre &amp; cruciferous veggies</ion-label>
          </ion-item>

          <ion-item class="clean-item">
            <ion-checkbox
              slot="start"
              [checked]="ironSupport()"
              (ionChange)="ironSupport.set($event.detail.checked)"
            ></ion-checkbox>
            <ion-label>Support iron levels (for heavy periods / low iron)</ion-label>
          </ion-item>
        </ion-list>

        <h2 class="section-title">üìÖ Plan duration</h2>

        <ion-segment
          [value]="duration()"
          (ionChange)="setDuration($event.detail.value ?? duration())"
        >
          <ion-segment-button value="7">
            <ion-label>Weekly</ion-label>
          </ion-segment-button>

          <ion-segment-button value="14">
            <ion-label>Biweekly</ion-label>
          </ion-segment-button>

          <ion-segment-button value="30">
            <ion-label>Monthly</ion-label>
          </ion-segment-button>
        </ion-segment>

        <div class="spacer"></div>

        <ion-button expand="block" class="primary-btn" (click)="generatePlan()" [disabled]="isLoading()">
          ‚ú® Generate My Healing Plan
        </ion-button>

        <div class="plan-banner" *ngIf="plan()">
          Plan generated ¬∑ {{ planRangeLabel() }}
        </div>
      </ion-card-content>
    </ion-card>

    <section class="plan-preview" *ngIf="plan() as plan">
      <div class="section-row">
        <h2>Today's rituals</h2>
      </div>

      <ion-accordion-group class="plan-accordion" [value]="fullPlanOpen() ? 'fullPlan' : undefined">
        <ion-accordion value="fullPlan">
          <ion-item slot="header" class="accordion-header" button detail="false" (click)="toggleFullPlan()">
            <ion-label>üìÖ View full plan (all days)</ion-label>
          </ion-item>

          <div slot="content" class="accordion-content">
            <div class="day-block" *ngFor="let day of plan.daysPlan">
              <div class="day-title">{{ formatDayTitle(day.date) }}</div>
              <div class="meal-list">
                <div class="meal-row" *ngFor="let meal of day.meals">
                  <div class="meal-thumb" [style.backgroundImage]="meal.imageUrl ? 'url(' + meal.imageUrl + ')' : ''">
                    <span class="thumb-dots">‚Ä¢‚Ä¢‚Ä¢</span>
                  </div>
                  <div class="meal-info">
                    <span [class]="mealTypeClass(meal.mealType)">{{ mealTypeLabel(meal.mealType) }}</span>
                    <div class="meal-name">{{ meal.name }}</div>
                    <div class="meal-sub">Supportive and balanced for today‚Äôs rhythm.</div>
                  </div>
                  <div class="meal-actions">
                    <ion-button
                      class="meal-swap"
                      size="small"
                      fill="outline"
                      (click)="openSwap(meal); $event.stopPropagation()">
                      Swap
                    </ion-button>
                    <ion-button
                      class="meal-view"
                      size="small"
                      fill="clear"
                      (click)="openMeal(meal.mealId); $event.stopPropagation()">
                      View
                    </ion-button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ion-accordion>
      </ion-accordion-group>

      <ion-card class="today-card" *ngIf="todayDay() as day; else noTodayCard">
        <ion-card-header>
          <ion-card-title>Today‚Äôs meals</ion-card-title>
        </ion-card-header>

        <ion-card-content>
          <div class="meal-list">
            <div class="meal-row" *ngFor="let meal of day.meals">
              <div class="meal-thumb" [style.backgroundImage]="meal.imageUrl ? 'url(' + meal.imageUrl + ')' : ''">
                <span class="thumb-dots">‚Ä¢‚Ä¢‚Ä¢</span>
              </div>
              <div class="meal-info">
                <span [class]="mealTypeClass(meal.mealType)">{{ mealTypeLabel(meal.mealType) }}</span>
                <div class="meal-name">{{ meal.name }}</div>
                <div class="meal-sub">Supportive and balanced for today‚Äôs rhythm.</div>
                <div class="meal-meta">
                  <span class="meal-tag">{{ focusTagLabel() }}</span>
                  <span class="meal-time">‚è± 15m</span>
                </div>
              </div>
              <ion-button fill="clear" size="small" class="meal-link" (click)="openMealDetails(meal.mealId)">
                View recipe
              </ion-button>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <ng-template #noTodayCard>
        <ion-card class="today-card">
          <ion-card-header>
            <ion-card-title>Today‚Äôs meals</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-text>
              Your plan doesn‚Äôt start today, but you can still view all days below.
            </ion-text>
          </ion-card-content>
        </ion-card>
      </ng-template>

      <ion-text *ngIf="shouldShowStartNotice()">
        <p class="start-notice">
          Your plan doesn‚Äôt start today, but you can still view all days below.
        </p>
      </ion-text>
    </section>
  </div>

  <ion-modal [isOpen]="startDatePickerOpen()" (didDismiss)="closeStartDatePicker()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Pick a start date</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeStartDatePicker()">Done</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="date-modal">
        <ion-datetime
          presentation="date"
          [value]="planStartDate()"
          (ionChange)="onStartDateChange($event.detail.value); closeStartDatePicker()">
        </ion-datetime>
      </ion-content>
    </ng-template>
  </ion-modal>

  <ion-modal [isOpen]="swapModalOpen()" (didDismiss)="closeSwap()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Swap recipe</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeSwap()">Close</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="swap-modal">
        <div class="swap-hero">
          <div class="swap-title">Pick a replacement</div>
          <div class="swap-sub">
            Current: <strong>{{ swapMeal()?.name || 'Selected meal' }}</strong>
          </div>
        </div>

        <ion-list>
          <ion-list-header>Suggested alternatives</ion-list-header>

          <ion-item *ngFor="let option of swapOptions()" button detail="false" class="swap-item">
            <ion-avatar slot="start" class="swap-avatar"></ion-avatar>
            <ion-label>
              <h3>{{ option.name }}</h3>
              <p>{{ option.meta }}</p>
            </ion-label>
            <ion-button fill="outline" size="small" (click)="applySwap(option)">Swap</ion-button>
          </ion-item>
        </ion-list>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
